<div style="display: contents;">
    <!-- Center Pane: Visualization -->
    <div id="center-pane" style="height: 100%; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; background: var(--bg-primary);">
        {% include "partials/visualizer.html" %}
    </div>

    <!-- Right Pane: Details & Resolution -->
    <div id="right-pane" style="height: 100%; display: flex; flex-direction: column; background: var(--bg-surface); border-left: 1px solid var(--border-color); overflow: hidden;">
        <!-- Tab Navigation -->
        <div style="display: flex; border-bottom: 1px solid var(--border-color); background: var(--bg-primary);">
            <button onclick="switchTab('info')" id="tab-info" class="mono" style="flex: 1; padding: 1rem; border: none; background: transparent; cursor: pointer; font-size: 0.75rem; font-weight: bold; color: var(--text-muted); transition: all 0.2s;">
                01. INFO
            </button>
            <button onclick="switchTab('resolve')" id="tab-resolve" class="mono active-tab" style="flex: 1; padding: 1rem; border: none; background: transparent; border-left: 1px solid var(--border-color); cursor: pointer; font-size: 0.75rem; font-weight: bold; color: var(--text-primary); transition: all 0.2s;">
                02. RESOLVE
            </button>
        </div>

        <div style="flex: 1; overflow-y: auto; padding: 1.5rem;">
            <!-- INFO TAB -->
            <div id="content-info" style="display: none; flex-direction: column; gap: 1.5rem;">
                <div style="border-bottom: 1px solid var(--grid-line); padding-bottom: 1rem;">
                    <h2 class="mono" style="margin: 0; font-size: 1rem;">Flight Profiles</h2>
                    <span class="mono" style="font-size: 0.5rem; color: var(--text-muted);">SYSTEM STATUS: TRACKING ACTIVE</span>
                </div>
                <div id="flight1-detail">
                    {% with flight=flight1, legs_count=legs1_count %}{% include "partials/flight_detail.html" %}{% endwith %}
                </div>
                <div id="flight2-detail">
                    {% with flight=flight2, legs_count=legs2_count %}{% include "partials/flight_detail.html" %}{% endwith %}
                </div>
            </div>

            <!-- RESOLVE TAB -->
            <div id="content-resolve" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div style="border-bottom: 1px solid var(--grid-line); padding-bottom: 1rem;">
                    <h2 class="mono" style="margin: 0; font-size: 1rem; color: #d9534f;">Tactical Solver</h2>
                    <span class="mono" style="font-size: 0.5rem; color: var(--text-muted);">SELECT AN OPTIMIZED RESOLUTION</span>
                </div>
                
                <div id="resolution-list" style="display: flex; flex-direction: column; gap: 1rem;">
                    <div class="mono" style="font-size: 0.625rem; opacity: 0.5; text-align: center; padding: 2rem;">
                        GENERATING TACTICAL OPTIONS...
                    </div>
                </div>
            </div>
        </div>

        <style>
            .active-tab {
                background: var(--bg-surface) !important;
                color: var(--text-primary) !important;
                box-shadow: inset 0 -2px 0 var(--border-color);
            }
        </style>

        <script>
            function switchTab(tab) {
                const infoBtn = document.getElementById('tab-info');
                const resolveBtn = document.getElementById('tab-resolve');
                const infoContent = document.getElementById('content-info');
                const resolveContent = document.getElementById('content-resolve');

                if (tab === 'info') {
                    infoBtn.classList.add('active-tab');
                    resolveBtn.classList.remove('active-tab');
                    infoBtn.style.color = 'var(--text-primary)';
                    resolveBtn.style.color = 'var(--text-muted)';
                    infoContent.style.display = 'flex';
                    resolveContent.style.display = 'none';
                } else {
                    resolveBtn.classList.add('active-tab');
                    infoBtn.classList.remove('active-tab');
                    resolveBtn.style.color = 'var(--text-primary)';
                    infoBtn.style.color = 'var(--text-muted)';
                    resolveContent.style.display = 'flex';
                    infoContent.style.display = 'none';
                    loadResolutions();
                }
            }

            async function loadResolutions() {
                const list = document.getElementById('resolution-list');
                const res = await fetch(`/api/resolutions/{{ acid1 }}/{{ acid2 }}`);
                const data = await res.json();
                
                if (data.proposals.length === 0) {
                    list.innerHTML = '<div class="mono" style="font-size: 0.625rem; opacity: 0.5; text-align: center; padding: 2rem;">NO CONFLICT-FREE RESOLUTIONS FOUND WITHIN CONSTRAINTS.</div>';
                    return;
                }

                list.innerHTML = data.proposals.map(p => `
                    <div class="feature-card" 
                         onmouseenter='window.showGhostTrajectory(${JSON.stringify(p.proposed_legs)})'
                         onmouseleave='window.hideGhostTrajectory()'
                         style="padding: 1.25rem; border-color: ${p.is_recommended ? '#5cb85c' : 'var(--border-color)'}; position: relative; background: var(--bg-primary); cursor: pointer; transition: transform 0.2s;">
                        ${p.is_recommended ? '<span class="badge" style="position: absolute; top: -10px; right: 10px; background: #5cb85c; color: white; border: none; font-size: 0.5rem;">RECOMMENDED</span>' : ''}
                        
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <span class="mono" style="font-weight: bold; font-size: 0.75rem; color: ${p.type === 'TIME' ? '#5cb85c' : '#f0ad4e'}">${p.title}</span>
                            <div style="text-align: right;">
                                <div class="mono" style="font-size: 0.875rem; font-weight: bold;">${p.metrics.efficiency_score}%</div>
                                <div class="mono" style="font-size: 0.4rem; color: var(--text-muted);">EFFICIENCY</div>
                            </div>
                        </div>

                        <p class="mono" style="font-size: 0.625rem; color: var(--text-muted); margin-bottom: 1rem; line-height: 1.4;">${p.description}</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem; padding: 0.5rem; background: var(--bg-surface); border: 1px solid var(--grid-line);">
                            <div>
                                <div class="mono" style="font-size: 0.4rem; color: var(--text-muted);">FUEL IMPACT</div>
                                <div class="mono" style="font-size: 0.625rem; font-weight: bold; color: ${p.metrics.fuel_impact_usd > 0 ? '#d9534f' : '#5cb85c'}">$${p.metrics.fuel_impact_usd}</div>
                            </div>
                            <div>
                                <div class="mono" style="font-size: 0.4rem; color: var(--text-muted);">TIME DELAY</div>
                                <div class="mono" style="font-size: 0.625rem; font-weight: bold; color: ${p.metrics.delay_impact_mins > 0 ? '#f0ad4e' : '#5cb85c'}">${p.metrics.delay_impact_mins}m</div>
                            </div>
                        </div>

                        <button onclick='applyResolution("{{ acid1 }}", ${JSON.stringify(p.changes)})' class="btn primary" style="width: 100%; font-size: 0.625rem; height: 32px;">APPLY RESOLUTION</button>
                    </div>
                `).join('');
            }

            async function applyResolution(acid, changes) {
                if (!confirm(`Apply tactical changes to ${acid}? This will update the flight schedule and re-calculate all conflicts.`)) return;
                
                const btn = event.target;
                const originalText = btn.innerText;
                btn.innerText = "APPLYING...";
                btn.disabled = true;

                try {
                    const res = await fetch(`/api/apply-fix/${acid}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(changes)
                    });
                    
                    if (res.ok) {
                        window.location.reload(); // Hard reload to clear all caches and states
                    }
                } catch (e) {
                    alert("Failed to apply resolution.");
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }

            // Initial load
            loadResolutions();
        </script>
    </div>
</div>
